@model IEnumerable<WebLabMVC.Models.Shop>

@{
    ViewData["Title"] = "Магазини";
}

<h1>Магазини</h1>

<p>
    <a asp-action="Create"><a asp-action="Create" class="btn btn-success">Додати магазин</a></a>
</p>
<table class="table">
    <thead>
        <tr>
            <th>Назва</th>
            <th>Адреса</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
@foreach (var item in Model) {
        <tr>
            <td>
                @Html.DisplayFor(modelItem => item.Name)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.Address)
            </td>
            <td>
                <a asp-action="Details" asp-route-id="@item.Id" class="btn btn-sm btn-info">Детальніше</a>
                <a asp-action="Edit" asp-route-id="@item.Id" class="btn btn-sm btn-primary">Редагувати</a>
                <a asp-action="Delete" asp-route-id="@item.Id" class="btn btn-sm btn-danger">Видалити</a>
            </td>
        </tr>
}
    </tbody>
</table>

<div class="mb-3">
    <label for="bookSelect" class="form-label">Виберіть книгу</label>
    <select id="bookSelect" class="form-select">
        <option value="">Не вибрано</option>
        @foreach (var book in ViewBag.Books as SelectList)
        {
            <option value="@book.Value">@book.Text</option>
        }
    </select>
</div>

<p id="noBookMessage" class="text-danger fw-bold"></p>

<div id="map" style="height: 400px; width: 100%;"></div>

@section Scripts {
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        const shops = @Html.Raw(Json.Serialize(Model.Select(s => new {
            s.Id,
            s.Name,
            s.Address,
            s.Latitude,
            s.Longitude,
            BookIds = s.Books.Select(b => b.Id).ToList()
        })));

        const map = L.map('map').setView([48.3794, 31.1656], 6); // Ukraine
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        let markers = [];

        function updateMap(bookId) {
                markers.forEach(m => map.removeLayer(m));
                markers = [];

                const filteredShops = bookId
                    ? shops.filter(s => s.bookIds.includes(parseInt(bookId)))
                    : shops;

                if (filteredShops.length > 0) {
                    filteredShops.forEach(shop => {
                        const lat = parseFloat(shop.latitude?.toString().replace(',', '.'));
                        const lng = parseFloat(shop.longitude?.toString().replace(',', '.'));

                        if (!isNaN(lat) && !isNaN(lng)) {
                            const marker = L.marker([lat, lng])
                                .bindPopup(`<b>${shop.name}</b>`);
                            marker.addTo(map);
                            markers.push(marker);
                        } else {
                            console.warn("Некоректні координати магазину:", shop);
                        }
                    });

                    const group = new L.featureGroup(markers);
                    map.fitBounds(group.getBounds().pad(0.2));

                    document.getElementById('noBookMessage').textContent = '';
                } else {
                    document.getElementById('noBookMessage').textContent = 'Цієї книги немає в наявності';
                }
            }


        document.getElementById('bookSelect').addEventListener('change', function() {
            updateMap(this.value);
        });

        updateMap(null);
    </script>
}